<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>اصلاح کانفیگ‌های V2Ray</title>
    <meta name="description" content="ابزاری برای اصلاح کانفیگ‌های V2Ray" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ipaddr.js/2.0.1/ipaddr.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
        }
        .bg-cloudflare {
            background-color: #f48120;
        }
        @media (min-width: 768px) {
            .container {
                max-width: 720px;
            }
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand me-0" href="https://seramo.github.io/v2ray-config-modifier/">اصلاح کانفیگ‌ها</a>
        <ul class="navbar-nav p-0">
            <li class="nav-item">
                <a class="nav-link active p-0" href="https://github.com/seramo/v2ray-config-modifier/">گیت‌هاب</a>
            </li>
        </ul>
    </div>
</nav>
<div class="container mt-5">
    <div class="row">
        <div class="col-12">
            <div class="alert" role="alert" id="messageBox" style="display: none;">
                <span id="messageText"></span>
            </div>
        </div>

        <div class="col-12">
            <label for="inputConfig" class="form-label">کانفیگ</label>
            <input type="text" id="inputConfig" class="form-control" placeholder="vless یا vmess" dir="ltr">
        </div>

        <div class="col-12 mt-3">
            <label for="inputType" class="form-label">نوع ورودی</label>
            <select id="inputType" class="form-control" onchange="toggleInputFields()">
                <option value="cidr">رنج آی پی</option>
                <option value="list">لیست آی پی</option>
            </select>
        </div>

        <div class="col-12 mt-3" id="cidrFields">
            <label for="ipRange" class="form-label">رنج آی پی (CIDR)</label>
            <button onclick="loadCloudflareIPRanges()" class="badge bg-cloudflare border-0 me-1">رنج آی پی‌های کلودفلر</button>
            <textarea id="ipRange" class="form-control" rows="4" placeholder="هر رنج آی پی در یک خط" dir="ltr"></textarea>

            <label for="outputCount" class="form-label mt-3">تعداد خروجی‌ها</label>
            <select id="outputCount" class="form-control">
                <option value="10000">10000</option>
                <option value="20000">20000</option>
                <option value="30000">30000</option>
                <option value="40000">40000</option>
                <option value="50000">50000</option>
                <option value="unlimited">بدون محدودیت</option>
            </select>
        </div>

        <div class="col-12 mt-3" id="listFields" style="display: none;">
            <label for="ipList" class="form-label">لیست آی پی‌</label>
            <textarea id="ipList" class="form-control" rows="8" placeholder="هر آی پی در یک خط" dir="ltr"></textarea>
        </div>

        <div class="col-12 mt-4">
            <button onclick="generateConfigs()" class="btn btn-primary">تولید کانفیگ‌ها</button>
            <button onclick="copyToClipboard()" class="btn btn-secondary px-4" id="copyButton" disabled>کپی</button>
            <button onclick="downloadOutput()" class="btn btn-success px-4" id="downloadButton" disabled>دانلود</button>
        </div>
    </div>
</div>
<script>
    let generatedOutput = '';

    function showMessage(message, type) {
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        messageText.textContent = message;

        messageBox.classList.remove('alert-success', 'alert-danger', 'alert-warning');

        switch(type) {
            case 'success':
                messageBox.classList.add('alert-success');
                break;
            case 'warning':
                messageBox.classList.add('alert-warning');
                break;
            case 'error':
            default:
                messageBox.classList.add('alert-danger');
        }

        messageBox.style.display = 'block';
    }

    function showError(message) {
        showMessage(message, 'error');
    }

    function showWarning(message) {
        showMessage(message, 'warning');
    }

    function showSuccess(message) {
        showMessage(message, 'success');
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function toggleInputFields() {
        const inputType = document.getElementById('inputType').value;
        const cidrFields = document.getElementById('cidrFields');
        const listFields = document.getElementById('listFields');

        if (inputType === 'cidr') {
            cidrFields.style.display = 'block';
            listFields.style.display = 'none';
        } else {
            cidrFields.style.display = 'none';
            listFields.style.display = 'block';
        }
    }

    function isValidCIDR(cidr) {
        return /^(\d{1,3}\.){3}\d{1,3}\/\d{1,2}$/.test(cidr) || /^[0-9a-fA-F:]+\/\d{1,3}$/.test(cidr);
    }

    function incrementIP(ip) {
        if (ip.kind() === 'ipv4') {
            let currentIpNumeric = ip.octets.reduce((acc, octet) => (acc << 8) + octet, 0);
            currentIpNumeric += 1;
            const nextIpOctets = [
                (currentIpNumeric >>> 24) & 0xFF,
                (currentIpNumeric >>> 16) & 0xFF,
                (currentIpNumeric >>> 8) & 0xFF,
                currentIpNumeric & 0xFF
            ];
            return new ipaddr.IPv4(nextIpOctets);
        } else if (ip.kind() === 'ipv6') {
            let parts = ip.parts.map(part => BigInt(part));
            let i = parts.length - 1;
            while (i >= 0) {
                parts[i] = parts[i] + 1n;
                if (parts[i] > 0xFFFFn) {
                    parts[i] = 0n;
                    i--;
                } else {
                    break;
                }
            }
            return ipaddr.IPv6.parse(parts.map(part => part.toString(16)).join(':'));
        }
    }

    function isValidConfigFormat(inputConfig) {
        if (inputConfig.startsWith('vmess://')) {
            return true;
        } else if (inputConfig.startsWith('vless://')) {
            const regex = /vless:\/\/[^@]+@[^:]+:.+/;
            return regex.test(inputConfig);
        }
        return false;
    }

    function generateConfigs() {
        const inputType = document.getElementById('inputType').value;
        const inputConfig = document.getElementById('inputConfig').value;

        if (!inputConfig) {
            showWarning('لطفا کانفیگ را وارد کنید.');
            return;
        }

        if (!isValidConfigFormat(inputConfig)) {
            showWarning('کانفیگ وارد شده معتبر نیست.');
            return;
        }

        if (inputType === 'cidr') {
            modifyConfigsFromCIDR();
        } else {
            modifyConfigsFromList();
        }
    }

    function modifyConfigsFromCIDR() {
        const inputConfig = document.getElementById('inputConfig').value;
        const ipRanges = document.getElementById('ipRange').value.trim().split('\n').filter(range => range.trim() !== '');
        const outputCount = document.getElementById('outputCount').value;

        if (ipRanges.length === 0) {
            showWarning('لطفا حداقل یک رنج آی پی را وارد کنید.');
            return;
        }

        for (const ipRange of ipRanges) {
            if (!isValidCIDR(ipRange.trim())) {
                showWarning(`لطفا یک رنج آی پی معتبر وارد کنید: ${ipRange}`);
                return;
            }
        }

        generatedOutput = '';
        let count = 0;

        for (const ipRange of ipRanges) {
            const [ip, range] = ipaddr.parseCIDR(ipRange.trim());
            const ipType = ip.kind();

            if (outputCount === 'unlimited' && ipType === 'ipv6') {
                showWarning('تعداد خروجی بدون محدودیت فقط برای رنج آی پی های ورژن 4 قابل استفاده است.');
                return;
            }

            let currentIp = ip;
            while (currentIp.match(ipaddr.parseCIDR(ipRange.trim())) && (outputCount === 'unlimited' || count < parseInt(outputCount))) {
                generatedOutput += replaceIPInConfig(inputConfig, currentIp);
                count++;

                if (outputCount !== 'unlimited' && count >= parseInt(outputCount)) {
                    break;
                }

                currentIp = incrementIP(currentIp);
            }
        }

        displayResult(count);
    }

    function modifyConfigsFromList() {
        const inputConfig = document.getElementById('inputConfig').value;
        const ipList = document.getElementById('ipList').value.trim().split('\n').filter(ip => ip.trim() !== '');

        if (ipList.length === 0) {
            showWarning('لطفا لیست آی پی‌ را وارد کنید.');
            return;
        }

        generatedOutput = '';

        for (const ip of ipList) {
            let ipStr = ip.trim();
            if (ipaddr.isValid(ipStr)) {
                generatedOutput += replaceIPInConfig(inputConfig, ipaddr.parse(ipStr));
            } else {
                showWarning(`آی پی نامعتبر یافت شد: ${ipStr}`);
                return;
            }
        }

        displayResult(ipList.length);
    }

    function replaceIPInConfig(inputConfig, ip) {
        let isVmess = inputConfig.startsWith('vmess://');
        let ipStr = ip.toString();
        let result = '';

        if (isVmess) {
            let vmessConfig = JSON.parse(atob(inputConfig.replace('vmess://', '')));
            vmessConfig.add = ipStr;
            result = `vmess://${btoa(JSON.stringify(vmessConfig))}\n\n`;
        } else {
            ipStr = ip.kind() === 'ipv6' ? `[${ipStr}]` : ipStr;
            const match = inputConfig.match(/^(vless:\/\/[^@]+)@([^:]+)(:.+)$/);
            const [_, start, domain, end] = match;
            result = `${start}@${ipStr}${end}\n\n`;
        }

        return result;
    }

    function displayResult(count) {
        if (generatedOutput) {
            showSuccess(`تولید ${count} کانفیگ با موفقیت انجام شد.`);
            document.getElementById('copyButton').disabled = false;
            document.getElementById('downloadButton').disabled = false;
        } else {
            showError('هیچ کانفیگی تولید نشد.');
            document.getElementById('copyButton').disabled = true;
            document.getElementById('downloadButton').disabled = true;
        }
    }

    function loadCloudflareIPRanges() {
        const cloudflareIPRanges = [
            '173.245.48.0/20',
            '103.21.244.0/22',
            '103.22.200.0/22',
            '103.31.4.0/22',
            '141.101.64.0/18',
            '108.162.192.0/18',
            '190.93.240.0/20',
            '188.114.96.0/20',
            '197.234.240.0/22',
            '198.41.128.0/17',
            '162.158.0.0/15',
            '104.16.0.0/13',
            '104.24.0.0/14',
            '172.64.0.0/13',
            '131.0.72.0/22'
        ];

        const shuffledIPRanges = shuffleArray(cloudflareIPRanges);

        document.getElementById('ipRange').value = shuffledIPRanges.join('\n');
    }

    function copyToClipboard() {
        if (generatedOutput) {
            navigator.clipboard.writeText(generatedOutput.replace(/\n\n/g, '\n').trimEnd()).then(() => {
                showSuccess('کانفیگ‌ها در کلیپ‌بورد ذخیره شدند.');
            }).catch(err => {
                console.error(err);
                showError('خطا در کپی: ' + err);
            });
        }
    }

    function downloadOutput() {
        if (generatedOutput) {
            const blob = new Blob([generatedOutput.replace(/\n\n/g, '\n').trimEnd()], { type: 'text/plain' });
            const now = new Date();
            const date = now.toISOString().split('T')[0];
            const time = now.toTimeString().split(' ')[0].replace(/:/g, '-');
            const fileName = `modified_configs_${date}_${time}.txt`;

            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            link.click();
            URL.revokeObjectURL(link.href);
        }
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>